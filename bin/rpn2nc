#!/usr/bin/env python

from sys import argv, exit, stdout
from os.path import exists
from pygeode.formats import netcdf as nc, rpn

if len(argv) != 3:
  print "Usage: %s <rpn_file> <netcdf_file>"%argv[0]
  exit(1)

rpnfile = argv[1]
ncfile = argv[2]

# Make sure input file exists
if not exists(rpnfile):
  print "Error: '%s' does not exist!"%(rpnfile)
  exit(1)

# Check if output file already exists
if exists(ncfile):
  overwrite = False
  if stdout.isatty():
    while True:
      print "Warning: '%s' already exists!  Overwrite? (y/n):"%(ncfile),
      ans = raw_input()
      if ans.lower() in ('y','yes'):
        overwrite = True
        break
      if ans.lower() in ('n','no'):
        overwrite = False
        break
      print "Sorry, invalid response."
  if overwrite is False:
    print "Refusing to overwrite existing file '%s'."%(ncfile)
    exit(1)


import warnings
with warnings.catch_warnings():
  warnings.simplefilter("ignore")

  # Load the input file
  data = rpn.open(rpnfile)

  # Write to netcdf
  try:
    nc.save(ncfile, data, version=3)
  except AssertionError:
    print "An error occurred while writing to a version 3 file."
    print "Attempting to write a version 4 file instead."
    nc.save(ncfile, data, version=4)

